<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Retrofit 源码分析 | 慌不要慌</title>
  <meta name="author" content="慌不要慌">
  
  <meta name="description" content="慌不要慌的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Retrofit 源码分析"/>
  <meta property="og:site_name" content="慌不要慌"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="慌不要慌" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">慌不要慌</a></h1>
  <h2><a href="/">若你喜欢怪人，其实我很美。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <!-- <li><a href="https://github.com/danke77">Github</a></li> -->
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-08-06T05:07:19.000Z"><a href="/2016/08/06/retrofit-source-analysis/">2016年08月06日</a></time>
      
      
  
    <h1 class="title">Retrofit 源码分析</h1>
  

    </header>
    <div class="entry">
      
        <p>&#x6700;&#x8FD1;&#x975E;&#x5E38;&#x6D41;&#x884C; <strong>Retrofit+RxJava+OkHttp</strong> &#x8FD9;&#x4E00;&#x6574;&#x5957;&#x7684;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x548C;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x7684;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#xFF0C;&#x4ECE; <a href="https://github.com/JakeWharton" target="_blank" rel="external">Jake Wharton</a> &#x7684; Github &#x4E3B;&#x9875;&#x4E5F;&#x80FD;&#x770B;&#x51FA;&#x5176;&#x8D8B;&#x52BF;&#x3002;</p>
<p><img src="/2016/08/06/retrofit-source-analysis/Retrofit+RxJava+OkHttp.png" alt="Retrofit+RxJava+OkHttp"></p>
<p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD; <strong>Retrofit</strong> &#x7684;&#x57FA;&#x672C;&#x539F;&#x7406;&#xFF0C;&#x57FA;&#x4E8E; <a href="https://github.com/square/retrofit/tree/parent-2.1.0" target="_blank" rel="external">2.1.0</a> &#x7248;&#x672C;&#x7684;&#x6E90;&#x7801;&#x3002;</p>
<h1 id="1-&#x57FA;&#x672C;&#x7528;&#x6CD5;"><a href="#1-&#x57FA;&#x672C;&#x7528;&#x6CD5;" class="headerlink" title="1. &#x57FA;&#x672C;&#x7528;&#x6CD5;"></a>1. &#x57FA;&#x672C;&#x7528;&#x6CD5;</h1><h3 id="1-1-&#x5B9A;&#x4E49;-API-&#x63A5;&#x53E3;"><a href="#1-1-&#x5B9A;&#x4E49;-API-&#x63A5;&#x53E3;" class="headerlink" title="1.1 &#x5B9A;&#x4E49; API &#x63A5;&#x53E3;"></a>1.1 &#x5B9A;&#x4E49; API &#x63A5;&#x53E3;</h3><p><code>Retrofit</code> &#x7684;&#x4F7F;&#x7528;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E2A; <a href="http://square.github.io/retrofit/" target="_blank" rel="external">&#x5B98;&#x7F51;</a> &#x4E0A;&#x7684;&#x793A;&#x4F8B;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>{</div><div class="line">    <span class="meta">@GET</span>(<span class="string">&quot;users/{user}/repos&quot;</span>)</div><div class="line">    Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">&quot;user&quot;</span>) String user);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5B98;&#x65B9;&#x7684;&#x89E3;&#x91CA;&#x662F;</p>
<blockquote>
<p>Retrofit turns your HTTP API into a Java interface.</p>
</blockquote>
<p>&#x9996;&#x5148;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A; API &#x63A5;&#x53E3; <code>GitHubService</code>&#xFF0C;&#x5305;&#x542B; HTTP &#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5; <code>GET</code> &#x548C;&#x53C2;&#x6570; <code>user</code>&#xFF0C;&#x53CA;&#x6210;&#x529F;&#x540E;&#x7684;&#x8FD4;&#x56DE;&#x7C7B;&#x578B; <code>List&lt;Repo&gt;</code>&#xFF0C;&#x65B9;&#x6CD5;&#x548C;&#x53C2;&#x6570;&#x7531;&#x6CE8;&#x89E3;&#x58F0;&#x660E;&#xFF0C;&#x975E;&#x5E38;&#x6E05;&#x6670;&#x3002;</p>
<h3 id="1-2-&#x521B;&#x5EFA;-Retrofit-&#x5BF9;&#x8C61;&#x5E76;&#x751F;&#x6210;-API-&#x5B9E;&#x4F8B;"><a href="#1-2-&#x521B;&#x5EFA;-Retrofit-&#x5BF9;&#x8C61;&#x5E76;&#x751F;&#x6210;-API-&#x5B9E;&#x4F8B;" class="headerlink" title="1.2 &#x521B;&#x5EFA; Retrofit &#x5BF9;&#x8C61;&#x5E76;&#x751F;&#x6210; API &#x5B9E;&#x4F8B;"></a>1.2 &#x521B;&#x5EFA; Retrofit &#x5BF9;&#x8C61;&#x5E76;&#x751F;&#x6210; API &#x5B9E;&#x4F8B;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">      .baseUrl(<span class="string">&quot;https://api.github.com/&quot;</span>)</div><div class="line">      .addConverterFactory(GsonConverterFactory.create())</div><div class="line">      .build();</div><div class="line">      </div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; <code>Retrofit</code> &#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x91CC;&#x91C7;&#x7528; <strong>Builder</strong> &#x6A21;&#x5F0F;&#xFF0C;&#x4F20;&#x5165; <code>baseUrl</code> &#x548C; <code>ConverterFactory</code> &#x7B49;&#x53C2;&#x6570;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x8BB2;&#x5230;&#x3002;</p>
<p>&#x901A;&#x8FC7; <code>Retrofit</code> &#x5BF9;&#x8C61;&#x7528;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7684;&#x65B9;&#x5F0F;&#x751F;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684; API &#x5B9E;&#x4F8B; <code>GitHubService</code>&#x3002;</p>
<h3 id="1-3-API-&#x5B9E;&#x4F8B;&#x53BB;&#x8BF7;&#x6C42;&#x670D;&#x52A1;"><a href="#1-3-API-&#x5B9E;&#x4F8B;&#x53BB;&#x8BF7;&#x6C42;&#x670D;&#x52A1;" class="headerlink" title="1.3 API &#x5B9E;&#x4F8B;&#x53BB;&#x8BF7;&#x6C42;&#x670D;&#x52A1;"></a>1.3 API &#x5B9E;&#x4F8B;&#x53BB;&#x8BF7;&#x6C42;&#x670D;&#x52A1;</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Call&lt;List&lt;Repo&gt;&gt; repoCall = service.listRepos(<span class="string">&quot;danke77&quot;</span>);</div></pre></td></tr></table></figure>
<p>&#x7528;&#x751F;&#x6210;&#x7684; API &#x5B9E;&#x4F8B;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x9ED8;&#x8BA4;&#x8FD4;&#x56DE; <code>Call&lt;T&gt;</code>&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528; <code>Call#execute</code> &#x65B9;&#x6CD5;&#x540C;&#x6B65;&#x6216;&#x8C03;&#x7528; <code>Call#enqueue</code> &#x65B9;&#x6CD5;&#x5F02;&#x6B65;&#x8BF7;&#x6C42; HTTP&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;Repo&gt; repos = repoCall.execute().body();</div></pre></td></tr></table></figure>
<p>&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;&#x76F4;&#x63A5;&#x8F6C;&#x5316;&#x6210;&#x4E86; <code>List&lt;Repo&gt;</code>&#xFF0C;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#x3002;</p>
<p>&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528; <strong>RxJava</strong>&#xFF0C;&#x5728;&#x521B;&#x5EFA; <code>Retrofit</code> &#x5BF9;&#x8C61;&#x65F6;&#x8981;&#x8C03;&#x7528; <code>addCallAdapterFactory(RxJavaCallAdapterFactory.create())</code>&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x4F1A;&#x4ECE; <code>Call&lt;T&gt;</code> &#x8F6C;&#x6362;&#x6210; <code>Observable&lt;T&gt;</code>&#x3002;</p>
<h1 id="2-Retrofit"><a href="#2-Retrofit" class="headerlink" title="2. Retrofit"></a>2. Retrofit</h1><h3 id="2-1-build"><a href="#2-1-build" class="headerlink" title="2.1 build"></a>2.1 build</h3><p>&#x5148;&#x770B;&#x4E00;&#x4E0B; <code>Retrofit.Builder</code> &#x7C7B;&#x91CC;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Platform platform;</div><div class="line"><span class="keyword">private</span> okhttp3.Call.Factory callFactory;</div><div class="line"><span class="keyword">private</span> HttpUrl baseUrl;</div><div class="line"><span class="keyword">private</span> List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">private</span> List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">private</span> Executor callbackExecutor;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> validateEagerly;</div></pre></td></tr></table></figure>
<p><code>Platform</code> &#x63D0;&#x4F9B;&#x4E86;3&#x4E2A;&#x5E73;&#x53F0;&#xFF1A;<code>Java8</code>&#xFF0C;<code>Android</code> &#x548C; <code>IOS</code>&#xFF0C;&#x5168;&#x90FD;&#x7EE7;&#x627F;&#x81EA; <code>Platform</code>&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x9759;&#x6001;&#x65B9;&#x6CD5; <code>Platform#findPlatform</code> &#x4F1A;&#x81EA;&#x52A8;&#x8BC6;&#x522B;&#x5C5E;&#x4E8E;&#x54EA;&#x4E00;&#x4E2A;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Platform <span class="title">findPlatform</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        Class.forName(<span class="string">&quot;android.os.Build&quot;</span>);</div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT != <span class="number">0</span>) {</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Android();</div><div class="line">        }</div><div class="line">    } <span class="keyword">catch</span> (ClassNotFoundException ignored) {</div><div class="line">    }</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        Class.forName(<span class="string">&quot;java.util.Optional&quot;</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Java8();</div><div class="line">    } <span class="keyword">catch</span> (ClassNotFoundException ignored) {</div><div class="line">    }</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        Class.forName(<span class="string">&quot;org.robovm.apple.foundation.NSObject&quot;</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IOS();</div><div class="line">    } <span class="keyword">catch</span> (ClassNotFoundException ignored) {</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Platform();</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7; <code>Retrofit.Builder#client</code> &#x6216; <code>Retrofit.Builder#callFactory</code> &#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49; <code>OkHttpClient</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">client</span><span class="params">(OkHttpClient client)</span> </span>{</div><div class="line">    <span class="keyword">return</span> callFactory(checkNotNull(client, <span class="string">&quot;client == null&quot;</span>));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">callFactory</span><span class="params">(okhttp3.Call.Factory factory)</span> </span>{</div><div class="line">    <span class="keyword">this</span>.callFactory = checkNotNull(factory, <span class="string">&quot;factory == null&quot;</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5982;&#x679C;&#x4E0D;&#x6307;&#x5B9A; <code>callFactory</code>&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528; <code>OkHttpClient</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</div><div class="line"><span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) {</div><div class="line">    callFactory = <span class="keyword">new</span> OkHttpClient();</div><div class="line">}</div></pre></td></tr></table></figure>
<p><code>converterFactories</code> &#x548C; <code>adapterFactories</code> &#x63D0;&#x4F9B;&#x4E86;2&#x4E2A;&#x5DE5;&#x5382;&#x5217;&#x8868;&#xFF0C;&#x7528;&#x4E8E;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x8F6C;&#x6362;&#x548C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
<p>&#x6700;&#x540E;&#x8C03;&#x7528; <code>Retrofit.Builder#build</code> &#x521B;&#x5EFA;&#x4E00;&#x4E2A; <code>Retrofit</code> &#x5BF9;&#x8C61;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>{</div><div class="line">    <span class="comment">// ... configured values</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</div><div class="line">          callbackExecutor, validateEagerly);</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="2-2-create"><a href="#2-2-create" class="headerlink" title="2.2 create"></a>2.2 create</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>{</div><div class="line">    Utils.validateServiceInterface(service);</div><div class="line">    <span class="keyword">if</span> (validateEagerly) {</div><div class="line">        eagerlyValidateMethods(service);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] { service }, <span class="keyword">new</span> InvocationHandler() {</div><div class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable {</div><div class="line">              <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></div><div class="line">              <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) {</div><div class="line">                  <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">              }</div><div class="line">              <span class="keyword">if</span> (platform.isDefaultMethod(method)) {</div><div class="line">                  <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">              }</div><div class="line">              ServiceMethod serviceMethod = loadServiceMethod(method);</div><div class="line">              OkHttpCall okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">              <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          }</div><div class="line">    });</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x8C03;&#x7528; <code>Utils.validateServiceInterface</code> &#x53BB;&#x5224;&#x65AD; <code>service</code> &#x662F;&#x5426;&#x662F;&#x4E00;&#x4E2A; <code>Interface</code> &#x4E14;&#x6CA1;&#x6709;&#x7EE7;&#x627F;&#x5176;&#x4ED6; <code>Interface</code>&#xFF0C;&#x5426;&#x5219;&#x629B;&#x975E;&#x6CD5;&#x53C2;&#x6570;&#x5F02;&#x5E38;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">validateServiceInterface</span><span class="params">(Class&lt;T&gt; service)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (!service.isInterface()) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;API declarations must be interfaces.&quot;</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (service.getInterfaces().length &gt; <span class="number">0</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;API interfaces must not extend other interfaces.&quot;</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5982;&#x679C; <code>validateEagerly</code> &#x4E3A; <code>true</code>&#xFF0C;&#x5219;&#x4F1A;&#x8C03;&#x7528; <code>eagerlyValidateMethods</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F1A;&#x53BB;&#x9884;&#x52A0;&#x8F7D; <code>service</code> &#x4E2D;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; <code>false</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eagerlyValidateMethods</span><span class="params">(Class&lt;?&gt; service)</span> </span>{</div><div class="line">    Platform platform = Platform.get();</div><div class="line">    <span class="keyword">for</span> (Method method : service.getDeclaredMethods()) {</div><div class="line">        <span class="keyword">if</span> (!platform.isDefaultMethod(method)) {</div><div class="line">            loadServiceMethod(method);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x751F;&#x6210; <code>service</code>&#x3002;&#x524D;&#x4E24;&#x4E2A; <code>if</code> &#x5206;&#x652F;&#x5206;&#x522B;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F; <code>Object</code> &#x7684;&#x65B9;&#x6CD5;&#x53CA; <code>default</code> &#x65B9;&#x6CD5;&#xFF0C;&#x540E;&#x8005;&#x9664;&#x4E86; <code>Java8</code> &#x5176;&#x4ED6;&#x90FD;&#x662F; <code>false</code>&#x3002;</p>
<p>&#x518D;&#x770B; <code>loadServiceMethod</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function">ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span> </span>{</div><div class="line">    ServiceMethod result;</div><div class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) {</div><div class="line">        result = serviceMethodCache.get(method);</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) {</div><div class="line">            result = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>, method).build();</div><div class="line">            serviceMethodCache.put(method, result);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7; <code>serviceMethodCache</code> &#x5B9E;&#x73B0;&#x7F13;&#x5B58;&#x673A;&#x5236;&#xFF0C;&#x540C;&#x4E00;&#x4E2A; <code>service</code> &#x7684;&#x540C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x53EA;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x6B21;&#xFF0C;&#x751F;&#x6210; <code>ServiceMethod</code> &#x540C;&#x65F6;&#x5B58;&#x5165; <code>Cache</code>&#x3002;</p>
<p>&#x7528; <code>ServiceMethod</code> &#x548C;&#x9700;&#x8981;&#x7684;&#x53C2;&#x6570;&#x751F;&#x6210;&#x4E00;&#x4E2A; <code>OkHttpCall</code> &#x5BF9;&#x8C61;&#x3002;&#x7136;&#x540E;&#x7528; <code>CallAdapter</code> &#x5C06;&#x751F;&#x6210;&#x7684; <code>OkHttpCall</code> &#x8F6C;&#x6362;&#x4E3A;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#xFF0C;&#x8FD9;&#x4E2A;&#x540E;&#x9762;&#x4F1A;&#x8BF4;&#x5230;&#x3002;</p>
<h1 id="3-ServiceMethod"><a href="#3-ServiceMethod" class="headerlink" title="3. ServiceMethod"></a>3. ServiceMethod</h1><blockquote>
<p>Adapts an invocation of an interface method into an HTTP call.</p>
</blockquote>
<p><code>ServiceMethod</code> &#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x628A;&#x4E00;&#x4E2A; API &#x65B9;&#x6CD5;&#x8F6C;&#x6362;&#x4E3A;&#x4E00;&#x4E2A; HTTP &#x8C03;&#x7528;&#x3002;</p>
<p>&#x4ECE; <code>Retrofit#loadServiceMethod</code> &#x65B9;&#x6CD5;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x4E00;&#x4E2A; API &#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A; <code>ServiceMethod</code>&#x3002;</p>
<p>&#x4EE5; <code>GitHubService</code>&#x4E3A;&#x4F8B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>{</div><div class="line">    <span class="meta">@GET</span>(<span class="string">&quot;users/{user}/repos&quot;</span>)</div><div class="line">    Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">&quot;user&quot;</span>) String user);</div><div class="line">}</div></pre></td></tr></table></figure>
<p><code>@GET(&quot;users/{user}/repos&quot;)</code> &#x662F; <code>MethodAnnotations</code>&#xFF0C;<code>@Path(&quot;user&quot;) String user</code> &#x662F; <code>ParameterAnnotations</code>&#xFF0C;<code>Call&lt;List&lt;Repo&gt;&gt;</code> &#x662F; <code>CallAdapter</code>&#x3002;</p>
<h3 id="3-1-ServiceMethod-Builder"><a href="#3-1-ServiceMethod-Builder" class="headerlink" title="3.1 ServiceMethod.Builder"></a>3.1 ServiceMethod.Builder</h3><p>&#x5148;&#x770B;&#x4E0B; <code>ServiceMethod.Builder</code> &#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(Retrofit retrofit, Method method)</span> </span>{</div><div class="line">    <span class="keyword">this</span>.retrofit = retrofit;</div><div class="line">    <span class="keyword">this</span>.method = method;</div><div class="line">    <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();</div><div class="line">    <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();</div><div class="line">    <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations(); </div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4F20;&#x5165; <code>retrofit</code> &#x548C; <code>method</code> &#x5BF9;&#x8C61;&#xFF0C;&#x901A;&#x8FC7; <code>method</code> &#x83B7;&#x53D6;&#x5230;&#x65B9;&#x6CD5;&#x6CE8;&#x89E3; <code>methodAnnotations</code>&#x3001;&#x53C2;&#x6570;&#x7C7B;&#x578B; <code>parameterTypes</code> &#x548C;&#x53C2;&#x6570;&#x6CE8;&#x89E3; <code>parameterAnnotationsArray</code>&#xFF0C;<code>parameterAnnotationsArray</code>&#x662F;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x6570;&#x7EC4; <code>Annotation[][]</code>&#xFF0C;&#x56E0;&#x4E3A;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;&#x6CE8;&#x89E3;&#x3002;</p>
<p>&#x5173;&#x952E;&#x770B; <code>ServiceMethod.Builder#build</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A; <code>ServiceMethod</code> &#x5BF9;&#x8C61;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x6309;&#x987A;&#x5E8F;&#x89E3;&#x6790;&#x3002;</p>
<h3 id="3-2-createCallAdapter"><a href="#3-2-createCallAdapter" class="headerlink" title="3.2 createCallAdapter"></a>3.2 createCallAdapter</h3><p><code>callAdapter = createCallAdapter()</code> &#x4F1A;&#x904D;&#x5386; <code>adapterFactories</code>&#xFF0C;&#x901A;&#x8FC7; API &#x65B9;&#x6CD5;&#x7684; <code>annotations</code> &#x548C; <code>returnType</code> &#x53D6;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684; <code>CallAdapter</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = adapterFactories.size(); i &lt; count; i++) {</div><div class="line">    CallAdapter&lt;?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, <span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> adapter;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x53D6;&#x5230; <code>responseType = callAdapter.responseType()</code> &#x5E76;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#xFF0C;&#x5982;&#x679C;&#x662F; <code>retrofit2.Response&lt;T&gt;</code> &#x6216; <code>okhttp3.Response</code> &#x5219;&#x629B;&#x5F02;&#x5E38;&#xFF0C;&#x76EE;&#x524D;&#x652F;&#x6301;&#x7684;&#x6709;&#x9ED8;&#x8BA4;&#x7684; <code>retrofit2.Call&lt;T&gt;</code>&#xFF0C;RxJava &#x7684; <code>rx.Observable</code>&#xFF0C;Java8 &#x7684; <code>java.util.concurrent.CompletableFuture</code> &#x548C; Guava &#x7684; <code>com.google.common.util.concurrent.ListenableFuture</code>&#x3002;</p>
<h3 id="3-3-createResponseConverter"><a href="#3-3-createResponseConverter" class="headerlink" title="3.3 createResponseConverter"></a>3.3 createResponseConverter</h3><p><code>responseConverter = createResponseConverter()</code> &#x4F1A;&#x904D;&#x5386; <code>converterFactories</code>&#xFF0C;&#x901A;&#x8FC7; API &#x65B9;&#x6CD5;&#x7684; <code>annotations</code> &#x548C; <code>responseType</code> &#x53D6;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684; <code>Converter&lt;ResponseBody, T&gt;</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = converterFactories.size(); i &lt; count; i++) {</div><div class="line">    Converter&lt;ResponseBody, ?&gt; converter =</div><div class="line">        converterFactories.get(i).responseBodyConverter(type, annotations, <span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (converter != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> (Converter&lt;ResponseBody, T&gt;) converter;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="3-4-parseMethodAnnotation"><a href="#3-4-parseMethodAnnotation" class="headerlink" title="3.4 parseMethodAnnotation"></a>3.4 parseMethodAnnotation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Annotation annotation : methodAnnotations) {</div><div class="line">    parseMethodAnnotation(annotation);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x904D;&#x5386; API &#x65B9;&#x6CD5;&#x7684;&#x6240;&#x6709; <code>annotations</code>&#xFF0C;&#x5982;&#x5B9E;&#x4F8B;&#x4E2D;&#x7684; <code>@GET(&quot;users/{user}/repos&quot;)</code>&#xFF0C;&#x6839;&#x636E;&#x6240;&#x5C5E;&#x7C7B;&#x578B;&#x548C;&#x503C;&#x89E3;&#x6790;&#x6210; HTTP &#x8BF7;&#x6C42;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>&#x5728; package <code>retrofit2.http</code> &#x4E0B;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;&#x7684; <code>Method Annotation</code> &#x548C; <code>Parameter Anootation</code>&#x3002;</p>
<p><code>DELETE</code>&#x3001;<code>GET</code>&#x3001;<code>HEAD</code>&#x3001;<code>PATHC</code>&#x3001;<code>POST</code>&#x3001;<code>PUT</code>&#x3001;<code>OPTIONS</code>&#x3001;<code>HTTP</code> &#x7C7B;&#x578B;&#x7684; <code>annotaion</code> &#x4F1A;&#x8C03;&#x7528; <code>parseHttpMethodAndPath</code>&#xFF0C;&#x751F;&#x6210; <code>httpMethod</code>&#x3001;<code>hasBody</code>&#x3001;<code>relativeUrl</code>&#x3001;<code>relativeUrlParamNames</code>&#x3002;</p>
<p><code>retrofit2.http.Headers</code> &#x7C7B;&#x578B;&#x7684; <code>annotaion</code> &#x4F1A;&#x8C03;&#x7528; <code>parseHeaders</code>&#xFF0C;&#x751F;&#x6210; <code>headers</code>&#x3002;</p>
<p><code>Multipart</code> &#x548C; <code>FormUrlEncoded</code> &#x7C7B;&#x578B;&#x7684; <code>annotaion</code> &#x5206;&#x522B;&#x751F;&#x6210; <code>isMultipart</code> &#x548C; <code>isFormEncoded</code>&#xFF0C;&#x4E24;&#x8005;&#x4E92;&#x65A5;&#xFF0C;&#x4E0D;&#x80FD;&#x540C;&#x65F6;&#x4E3A; <code>true</code>&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x629B;&#x5F02;&#x5E38;&#x3002;</p>
<p>&#x7136;&#x540E;&#x5BF9;&#x751F;&#x6210;&#x7684;&#x90E8;&#x5206;&#x53C2;&#x6570;&#x68C0;&#x67E5;&#xFF0C;<code>httpMethod</code> &#x4E0D;&#x80FD;&#x4E3A;&#x7A7A;&#xFF0C;&#x5982;&#x679C; <code>hasBody</code> &#x4E3A; <code>false</code>&#xFF0C;&#x5219; <code>isMultipart</code> &#x548C; <code>isFormEncoded</code> &#x5FC5;&#x987B;&#x4E5F;&#x4E3A; <code>false</code>&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x629B;&#x5F02;&#x5E38;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) {</div><div class="line">    <span class="keyword">throw</span> methodError(<span class="string">&quot;HTTP method annotation is required (e.g., @GET, @POST, etc.).&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!hasBody) {</div><div class="line">    <span class="keyword">if</span> (isMultipart) {</div><div class="line">        <span class="keyword">throw</span> methodError(</div><div class="line">            <span class="string">&quot;Multipart can only be specified on HTTP methods with request body (e.g., @POST).&quot;</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (isFormEncoded) {</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;FormUrlEncoded can only be specified on HTTP methods with &quot;</span></div><div class="line">            + <span class="string">&quot;request body (e.g., @POST).&quot;</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="3-5-parseParameterAnnotation"><a href="#3-5-parseParameterAnnotation" class="headerlink" title="3.5 parseParameterAnnotation"></a>3.5 parseParameterAnnotation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) {</div><div class="line">    ...  </div><div class="line">    Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">    parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x904D;&#x5386;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x7684; <code>parameterAnnotations</code>&#xFF0C;&#x5982;&#x5B9E;&#x4F8B;&#x4E2D;&#x7684; <code>@Path(&quot;user&quot;) String user</code>&#xFF0C;&#x6839;&#x636E;&#x6240;&#x5C5E;&#x7C7B;&#x578B;&#x548C;&#x503C;&#x89E3;&#x6790;&#x6210;&#x5BF9;&#x5E94;&#x7684; <code>ParameterHandler</code>&#xFF0C;&#x6BCF;&#x4E2A; <code>Parameter Anootation</code> &#x7C7B;&#x578B;&#x90FD;&#x6709;&#x5BF9;&#x5E94;&#x7684; <code>ParameterHandler</code>&#xFF0C;&#x4E14;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A; <code>ParameterHandler</code>&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x4E0B; <code>parseParameter</code> &#x7684;&#x903B;&#x8F91;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ParameterHandler&lt;?&gt; parseParameter(</div><div class="line">        <span class="keyword">int</span> p, Type parameterType, Annotation[] annotations) {</div><div class="line">    ParameterHandler&lt;?&gt; result = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">for</span> (Annotation annotation : annotations) {</div><div class="line">        ParameterHandler&lt;?&gt; annotationAction = parseParameterAnnotation(</div><div class="line">            p, parameterType, annotations, annotation);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (annotationAction == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">throw</span> parameterError(p, <span class="string">&quot;Multiple Retrofit annotations found, only one allowed.&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        result = annotationAction;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">throw</span> parameterError(p, <span class="string">&quot;No Retrofit annotation found.&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5173;&#x952E;&#x5728; <code>parseParameterAnnotation</code>&#xFF0C;&#x6839;&#x636E; <code>annotation</code> &#x7684;&#x7C7B;&#x578B;&#x5E76;&#x505A;&#x53C2;&#x6570;&#x6821;&#x9A8C;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x4E0D;&#x540C;&#x7684; <code>ParameterHandler</code>&#xFF0C;&#x5982; <code>RelativeUrl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (type == HttpUrl.class</div><div class="line">    || type == String.class</div><div class="line">    || type == URI.class</div><div class="line">    || (type <span class="keyword">instanceof</span> Class &amp;&amp; <span class="string">&quot;android.net.Uri&quot;</span>.equals(((Class&lt;?&gt;) type).getName()))) {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ParameterHandler.RelativeUrl();</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">    <span class="keyword">throw</span> parameterError(p, <span class="string">&quot;@Url must be okhttp3.HttpUrl, String, java.net.URI, or android.net.Uri type.&quot;</span>);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x7531;&#x4E8E; Retrofit &#x4E0D;&#x4F9D;&#x8D56; Android SDK&#xFF0C;&#x5224;&#x65AD; <code>type</code> &#x65F6;&#x65E0;&#x6CD5;&#x83B7;&#x53D6;&#x5230; <code>android.net.Uri.class</code>&#xFF0C;&#x56E0;&#x6B64;&#x91C7;&#x7528;&#x4E86; <code>&quot;android.net.Uri&quot;.equals(((Class&lt;?&gt;) type).getName())</code> &#x7684;&#x6280;&#x5DE7;&#x3002;</p>
<p>&#x6BCF;&#x4E2A; <code>Parameter Anootation</code> &#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A; <code>ParameterHandler</code>&#xFF0C;&#x5982; <code>static final class Path&lt;T&gt; extends ParameterHandler&lt;T&gt;</code>&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x5B9E;&#x73B0;&#x4E86; <code>ParameterHandler&lt;T&gt;</code>&#x3002;</p>
<table>
<thead>
<tr>
<th style="text-align:left">ParameterAnnotation</th>
<th style="text-align:left">? extends ParameterHandler</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Url</td>
<td style="text-align:left">RelativeUrl</td>
</tr>
<tr>
<td style="text-align:left">Path</td>
<td style="text-align:left">Path</td>
</tr>
<tr>
<td style="text-align:left">Query</td>
<td style="text-align:left">Query</td>
</tr>
<tr>
<td style="text-align:left">QueryMap</td>
<td style="text-align:left">QueryMap</td>
</tr>
<tr>
<td style="text-align:left">Header</td>
<td style="text-align:left">Header</td>
</tr>
<tr>
<td style="text-align:left">HeaderMap</td>
<td style="text-align:left">HeaderMap</td>
</tr>
<tr>
<td style="text-align:left">Field</td>
<td style="text-align:left">Field</td>
</tr>
<tr>
<td style="text-align:left">FieldMap</td>
<td style="text-align:left">FieldMap</td>
</tr>
<tr>
<td style="text-align:left">Part</td>
<td style="text-align:left">Part</td>
</tr>
<tr>
<td style="text-align:left">PartMap</td>
<td style="text-align:left">PartMap</td>
</tr>
<tr>
<td style="text-align:left">Body</td>
<td style="text-align:left">Body</td>
</tr>
</tbody>
</table>
<p>&#x6BCF;&#x79CD; <code>ParameterHandler</code> &#x90FD;&#x901A;&#x8FC7; <code>Converter&lt;F, T&gt;</code> &#x5C06;&#x6211;&#x4EEC;&#x7684;&#x4F20;&#x53C2;&#x7C7B;&#x578B;&#x8F6C;&#x5316;&#x6210; <code>RequestBuilder</code> &#x9700;&#x8981;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x53C2;&#x6570;&#x3002;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Query</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ParameterHandler</span>&lt;<span class="title">T</span>&gt; </span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Converter&lt;T, String&gt; valueConverter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> encoded;</div><div class="line"></div><div class="line">    Query(String name, Converter&lt;T, String&gt; valueConverter, <span class="keyword">boolean</span> encoded) {</div><div class="line">        <span class="keyword">this</span>.name = checkNotNull(name, <span class="string">&quot;name == null&quot;</span>);</div><div class="line">        <span class="keyword">this</span>.valueConverter = valueConverter;</div><div class="line">        <span class="keyword">this</span>.encoded = encoded;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestBuilder builder, T value)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// Skip null values.</span></div><div class="line">        builder.addQueryParam(name, valueConverter.convert(value), encoded);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p><code>valueConverter.convert</code> &#x5C06;&#x6211;&#x4EEC;&#x7684;&#x4F20;&#x53C2;&#x7C7B;&#x578B; <code>T</code> &#x8F6C;&#x6362;&#x6210; <code>String</code>&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5230; <code>RequestBuilder</code> &#x4E2D;&#x3002;&#x5176;&#x4ED6;&#x7684;&#x914D;&#x7F6E;&#x4E5F;&#x662F;&#x6309;&#x540C;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<h1 id="4-OkHttpCall"><a href="#4-OkHttpCall" class="headerlink" title="4. OkHttpCall"></a>4. OkHttpCall</h1><p><code>OkHttpCall</code> &#x5B9E;&#x73B0;&#x4E86; <code>retrofit2.Call&lt;T&gt;</code>&#xFF0C;&#x770B;&#x4E0B;&#x5B83;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165; <code>ServiceMethod</code> &#x548C;&#x8BF7;&#x6C42;&#x53C2;&#x6570;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">OkHttpCall(ServiceMethod&lt;T&gt; serviceMethod, Object[] args) {</div><div class="line">    <span class="keyword">this</span>.serviceMethod = serviceMethod;</div><div class="line">    <span class="keyword">this</span>.args = args;</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="4-1-createRawCall"><a href="#4-1-createRawCall" class="headerlink" title="4.1 createRawCall"></a>4.1 createRawCall</h3><p>&#x5148;&#x770B;&#x4E0B; <code>OkHttpCall#createRawCall</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    Request request = serviceMethod.toRequest(args);</div><div class="line">    okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">    <span class="keyword">if</span> (call == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Call.Factory returned null.&quot;</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> call;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5C06;&#x5DF2;&#x7ECF;&#x751F;&#x6210;&#x7684; <code>serviceMethod</code> &#x901A;&#x8FC7; <code>toRequest(args)</code> &#x8F6C;&#x6210;&#x4E00;&#x4E2A; <code>okhttp3.Request</code> &#x5BF9;&#x8C61;&#x3002;&#x518D;&#x7528;&#x521B;&#x5EFA; <code>Retrofit</code> &#x65F6;&#x6307;&#x5B9A;&#x7684; <code>okhttp3.Call.Factory</code> &#x521B;&#x5EFA;&#x4E00;&#x4E2A; <code>okhttp3.Call</code>&#xFF0C;&#x8FD9;&#x91CC;&#x5982;&#x679C;&#x4E0D;&#x6307;&#x5B9A; <code>okhttp3.Call.Factory</code>&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x662F; <code>okhttp3.OkHttpClient</code>&#x3002;</p>
<p>&#x5728; <code>ServiceMethod#toRequest</code> &#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x7528; <code>method</code> &#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#x751F;&#x6210;&#x4E00;&#x4E2A; <code>retrofit2.RequestBuilder</code> &#x540E;&#xFF0C;&#x518D;&#x7528;&#x4E4B;&#x524D;&#x51C6;&#x5907;&#x597D;&#x7684; <code>parameterHandlers</code> &#x5904;&#x7406;&#x6BCF;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x6700;&#x540E;&#x751F;&#x6210;&#x4E00;&#x4E2A; <code>okhttp3.Request</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Builds an HTTP request from method arguments. */</span></div><div class="line"><span class="function">Request <span class="title">toRequest</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    RequestBuilder requestBuilder = <span class="keyword">new</span> RequestBuilder(httpMethod, baseUrl, relativeUrl, headers, contentType, hasBody, isFormEncoded, isMultipart);</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">&quot;unchecked&quot;</span>) <span class="comment">// It is an error to invoke a method with the wrong arg types.</span></div><div class="line">    ParameterHandler&lt;Object&gt;[] handlers = (ParameterHandler&lt;Object&gt;[]) parameterHandlers;</div><div class="line"></div><div class="line">	<span class="comment">// ... &#x6821;&#x9A8C;</span></div><div class="line">	</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; argumentCount; p++) {</div><div class="line">        handlers[p].apply(requestBuilder, args[p]);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> requestBuilder.build();</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="4-2-execute"><a href="#4-2-execute" class="headerlink" title="4.2 execute"></a>4.2 execute</h3><p><code>okhttp3.Call#execute</code> &#x7528;&#x4E8E;&#x540C;&#x6B65;&#x8BF7;&#x6C42; HTTP&#xFF0C;&#x7EBF;&#x7A0B;&#x4F1A;&#x88AB;&#x963B;&#x585E;&#xFF0C;&#x8BF7;&#x6C42;&#x6210;&#x529F;&#x540E;&#x8FD4;&#x56DE;&#x6211;&#x4EEC;&#x6307;&#x5B9A;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response&lt;T&gt; <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    okhttp3.Call call;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</div><div class="line">        <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already executed.&quot;</span>);</div><div class="line">        executed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (creationFailure != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">if</span> (creationFailure <span class="keyword">instanceof</span> IOException) {</div><div class="line">                <span class="keyword">throw</span> (IOException) creationFailure;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">throw</span> (RuntimeException) creationFailure;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        call = rawCall;</div><div class="line">        <span class="keyword">if</span> (call == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                call = rawCall = createRawCall();</div><div class="line">            } <span class="keyword">catch</span> (IOException | RuntimeException e) {</div><div class="line">                creationFailure = e;</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (canceled) {</div><div class="line">        call.cancel();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> parseResponse(call.execute());</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x68C0;&#x67E5; <code>okhttp3.Call</code> &#x662F;&#x5426;&#x5DF2;&#x88AB;&#x6267;&#x884C;&#x3002;</p>
<p>&#x4E00;&#x4E2A; <code>okhttp3.Call</code> &#x53EA;&#x80FD;&#x88AB;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x53EF;&#x4EE5;&#x8C03;&#x7528; <code>OkHttpCall#clone</code> &#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x76F8;&#x540C;&#x914D;&#x7F6E;&#x7684; HTTP &#x8BF7;&#x6C42;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> OkHttpCall&lt;T&gt; <span class="title">clone</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x68C0;&#x67E5;&#x5E76;&#x521B;&#x5EFA; <code>okhttp3.Call</code>&#xFF0C;&#x8C03;&#x7528; <code>okhttp3.Call#execute</code> &#x6267;&#x884C;&#x540C;&#x6B65;&#x8BF7;&#x6C42;&#x3002;</p>
<p>&#x6700;&#x540E;&#x8C03;&#x7528; <code>parsePesponse</code> &#x5C06;&#x8FD4;&#x56DE;&#x7684; <code>okhttp3.Response</code> &#x89E3;&#x6790;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    ResponseBody rawBody = rawResponse.body();</div><div class="line"></div><div class="line">    <span class="comment">// Remove the body&apos;s source (the only stateful object) so we can pass the response along.</span></div><div class="line">    rawResponse = rawResponse.newBuilder()</div><div class="line">        .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> code = rawResponse.code();</div><div class="line">    <span class="comment">// ... &#x72B6;&#x6001;&#x7801;&#x68C0;&#x67E5;</span></div><div class="line"></div><div class="line">    ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        T body = serviceMethod.toResponse(catchingBody);</div><div class="line">        <span class="keyword">return</span> Response.success(body, rawResponse);</div><div class="line">    } <span class="keyword">catch</span> (RuntimeException e) {</div><div class="line">        <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></div><div class="line">        <span class="comment">// a runtime exception.</span></div><div class="line">        catchingBody.throwIfCaught();</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5BF9; <code>okhttp3.Response</code> &#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x72B6;&#x6001;&#x7801;&#x68C0;&#x67E5;&#x540E;&#x8C03;&#x7528; <code>ServiceMethod#toResponse</code> &#x751F;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x3002;&#x8FD9;&#x91CC;&#x5C31;&#x7528;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x51C6;&#x5907;&#x597D;&#x7684; <code>responseConverter</code>&#x3002;&#x6700;&#x540E;&#x5C01;&#x88C5;&#x6210;&#x4E00;&#x4E2A; <code>retrofit2.Response&lt;T&gt;</code>&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x539F;&#x59CB;&#x7684; <code>rawResponse</code>&#x3001;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684; <code>body</code> &#x548C; <code>errorBody</code>&#xFF0C;&#x6211;&#x4EEC;&#x53D6;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<h3 id="4-3-enqueue"><a href="#4-3-enqueue" class="headerlink" title="4.3 enqueue"></a>4.3 enqueue</h3><p><code>okhttp3.Call#enqueue</code> &#x548C; <code>okhttp3.Call#execute</code> &#x6D41;&#x7A0B;&#x7C7B;&#x4F3C;&#xFF0C;&#x5F02;&#x6B65;&#x8BF7;&#x6C42; HTTP&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x56DE;&#x8C03;&#x90FD;&#x4EA4;&#x7ED9; <code>retrofit2.Callback&lt;T&gt;</code> &#x5904;&#x7406;&#x3002;</p>
<p>&#x770B;&#x4E0B; <code>retrofit2.Callback#onFailure</code> &#x7684;&#x6CE8;&#x91CA;</p>
<blockquote>
<p>Invoked when a network exception occurred talking to the server or when an unexpected exception occurred creating the request or processing the response.</p>
</blockquote>
<p>&#x8FD9;&#x91CC; <code>retrofit2.Callback#onFailure</code> &#x9664;&#x4E86;&#x5904;&#x7406;&#x7F51;&#x7EDC;&#x5F02;&#x5E38;&#x5916;&#xFF0C;&#x8FD8;&#x4F1A;&#x5904;&#x7406;&#x521B;&#x5EFA;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x548C;&#x89E3;&#x6790;&#x6570;&#x636E;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x5728;&#x56DE;&#x8C03;&#x4E2D;&#x5904;&#x7406;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5; crash&#xFF0C;&#x8FD9;&#x70B9;&#x505A;&#x7684;&#x975E;&#x5E38;&#x597D;&#x3002;</p>
<ol>
<li><p><code>createRawCall</code> &#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> {</div><div class="line">   	call = rawCall = createRawCall();</div><div class="line">} <span class="keyword">catch</span> (Throwable t) {</div><div class="line">   	failure = creationFailure = t;</div><div class="line">}</div></pre></td></tr></table></figure>
<p> &#x5982;&#x679C;&#x51FA;&#x5F02;&#x5E38;&#xFF0C;&#x76F4;&#x63A5;&#x56DE;&#x8C03;&#xFF0C;&#x4E0D;&#x6267;&#x884C;&#x63A5;&#x4E0B;&#x6765; <code>enqueue</code> &#x65B9;&#x6CD5;&#x3002;</p>
</li>
<li>&#x6267;&#x884C; <code>okhttp3.Call#enqueue</code> &#x65F6; <code>okhttp3.Callback</code> &#x629B;&#x51FA;&#x7684;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x5F02;&#x5E38;</li>
<li><p>&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x6210;&#x529F;&#x540E;&#x5728; <code>okhttp3.Callback#onResponse</code> &#x4E2D; <code>parseResponse</code> &#x65F6;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> {</div><div class="line">       response = parseResponse(rawResponse);</div><div class="line">   } <span class="keyword">catch</span> (Throwable e) {</div><div class="line">       callFailure(e);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   }</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="5-CallAdapter"><a href="#5-CallAdapter" class="headerlink" title="5. CallAdapter"></a>5. CallAdapter</h1><p>&#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x8FC7; <code>ServiceMethod#createCallAdapter</code>&#xFF0C;&#x5B83;&#x4F1A;&#x4ECE; <code>adapterFactories</code> &#x4E2D;&#x627E;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684; <code>CallAdapter.Factory</code>&#x3002;</p>
<h3 id="5-1-retrofit-adapters"><a href="#5-1-retrofit-adapters" class="headerlink" title="5.1 retrofit-adapters"></a>5.1 retrofit-adapters</h3><p>&#x5148;&#x6765;&#x770B; Retrofit &#x63D0;&#x4F9B;&#x7684; <code>retrofit-adapters</code> &#x6A21;&#x5757;&#xFF0C;&#x76EE;&#x524D;&#x4F9B;&#x6211;&#x4EEC;&#x9009;&#x62E9;&#x4F7F;&#x7528;&#x7684;&#x6709; <code>guava</code>&#x3001;<code>java8</code> &#x548C; <code>rxjava</code>&#xFF0C;&#x5206;&#x522B;&#x5BF9;&#x5E94;&#x7684; <code>CallAdapter.Factory</code> &#x662F; <code>GuavaCallAdapterFactory</code>&#x3001;<code>Java8CallAdapterFactory</code> &#x548C; <code>RxJavaCallAdapterFactory</code>&#x3002;</p>
<p>&#x5728; <code>Retrofit#build</code> &#x65F6;&#xFF0C;&#x9664;&#x4E86;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x6DFB;&#x52A0;&#x7684; <code>CallAdapter.Factory</code>&#xFF0C; &#x8FD8;&#x4F1A;&#x6DFB;&#x52A0;&#x4E24;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684; <code>CallAdapter.Factory</code>&#xFF1A;<code>ExecutorCallAdapterFactory</code> &#x548C; <code>DefaultCallAdapterFactory</code>&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Make a defensive copy of the adapters and add the default Call adapter.</span></div><div class="line">List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</div><div class="line">adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div></pre></td></tr></table></figure>
<p>&#x5728; <code>Retrofit</code> &#x6E90;&#x7801;&#x4E2D;&#x6709;&#x5927;&#x91CF;&#x7C7B;&#x4F3C; <code>List&lt;CallAdapter.Factory&gt; adapterFactories = new ArrayList&lt;&gt;(this.adapterFactories);</code> &#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x91CD;&#x65B0;&#x62F7;&#x8D1D;&#x7ED9;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x6837;&#x867D;&#x7136;&#x591A;&#x7533;&#x8BF7;&#x4E86;4&#x4E2A;&#x5B57;&#x8282;&#x5185;&#x5B58;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x4EE5;&#x540E;&#x5C06;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x6539;&#x6210;&#x5165;&#x53C2;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4E0D;&#x7528;&#x6539;&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x4E86;&#xFF0C;&#x662F;&#x4E00;&#x79CD;&#x597D;&#x7684;&#x7F16;&#x7801;&#x4E60;&#x60EF;&#x3002;</p>
<h3 id="5-2-default"><a href="#5-2-default" class="headerlink" title="5.2 default"></a>5.2 default</h3><p>&#x518D;&#x770B;&#x9ED8;&#x8BA4;&#x7684; <code>CallAdapter.Factory</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CallAdapter.<span class="function">Factory <span class="title">defaultCallAdapterFactory</span><span class="params">(Executor callbackExecutor)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (callbackExecutor != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallAdapterFactory(callbackExecutor);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> DefaultCallAdapterFactory.INSTANCE;</div><div class="line">}</div></pre></td></tr></table></figure>
<p><code>DefaultCallAdapterFactory</code> &#x548C; <code>ExecutorCallAdapterFactory</code> &#x8FD4;&#x56DE;&#x7684;&#x7C7B;&#x578B;&#x90FD;&#x662F; <code>retrofit2.Call&lt;R&gt;</code>&#x3002;</p>
<p>&#x5728; <code>DefaultCallAdapterFactory</code> &#x4E2D;&#xFF0C;<code>CallAdapter#adapt</code> &#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x505A;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE; <code>retrofit2.Call&lt;R&gt;</code>&#x3002;&#x800C; <code>ExecutorCallAdapterFactory</code> &#x7684; <code>CallAdapter#adapt</code> &#x5219;&#x8FD4;&#x56DE; <code>ExecutorCallbackCall&lt;T&gt;</code>&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86; <code>retrofit2.Call&lt;R&gt;</code>&#xFF0C;&#x4F1A;&#x4F20;&#x5165;&#x4E00;&#x4E2A; <code>Executor</code>&#xFF0C;&#x540C;&#x6B65;&#x8C03;&#x7528;&#x4E0D;&#x53D8;&#xFF0C;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x65F6;&#x4F1A;&#x5728;&#x6307;&#x5B9A;&#x7684; <code>Executor</code> &#x4E0A;&#x6267;&#x884C;&#x3002;</p>
<h3 id="5-3-adapt"><a href="#5-3-adapt" class="headerlink" title="5.3 adapt"></a>5.3 adapt</h3><p>&#x770B;&#x4E0B; <code>CallAdapter</code> &#x7684; <code>adapt</code> &#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Returns an instance of {<span class="doctag">@code</span> T} which delegates to {<span class="doctag">@code</span> call}.</div><div class="line">  */</div><div class="line">&lt;R&gt; <span class="function">T <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span></span>;</div></pre></td></tr></table></figure>
<p>&#x5B83;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x628A; <code>retrofit2.Call&lt;R&gt;</code> &#x8F6C;&#x6362;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684; <code>T</code>&#x3002;</p>
<table>
<thead>
<tr>
<th style="text-align:left">CallAdapters</th>
<th style="text-align:left">? extends CallAdapter.Factory</th>
<th style="text-align:left">T</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">guava</td>
<td style="text-align:left">retrofit2.adapter.guava.GuavaCallAdapterFactory</td>
<td style="text-align:left">com.google.common.util.concurrent.ListenableFuture</td>
</tr>
<tr>
<td style="text-align:left">java8</td>
<td style="text-align:left">retrofit2.adapter.java8.Java8CallAdapterFactory</td>
<td style="text-align:left">java.util.concurrent.CompletableFuture</td>
</tr>
<tr>
<td style="text-align:left">rxjava</td>
<td style="text-align:left">retrofit2.adapter.rxjava.RxJavaCallAdapterFactory</td>
<td style="text-align:left">rx.Observable</td>
</tr>
<tr>
<td style="text-align:left">default</td>
<td style="text-align:left">retrofit2.ExecutorCallAdapterFactory</td>
<td style="text-align:left">retrofit2.Call<r></r></td>
</tr>
<tr>
<td style="text-align:left">default</td>
<td style="text-align:left">retrofit2.DefaultCallAdapterFactory</td>
<td style="text-align:left">retrofit2.Call<r></r></td>
</tr>
</tbody>
</table>
<p><code>List&lt;CallAdapter.Factory&gt;</code> &#x4E2D;&#x6DFB;&#x52A0;&#x7684;&#x987A;&#x5E8F;&#x662F;&#x6211;&#x4EEC;&#x6307;&#x5B9A;&#x7684;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A; <code>CallAdapter.Factory</code>&#xFF0C;&#x9ED8;&#x8BA4;&#x7684; <code>ExecutorCallAdapterFactory</code> &#x548C; <code>DefaultCallAdapterFactory</code>&#xFF0C;&#x67E5;&#x627E;&#x65F6;&#x6309;&#x987A;&#x5E8F;&#x67E5;&#x627E;&#x3002;</p>
<h1 id="6-Converter"><a href="#6-Converter" class="headerlink" title="6. Converter"></a>6. Converter</h1><p><code>Converter</code> &#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x5C06; HTTP &#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;&#x683C;&#x5F0F;&#x8F6C;&#x6362;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x6216;&#x5C06;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7684;&#x5BF9;&#x8C61;&#x8F6C;&#x6362;&#x6210; HTTP &#x8BF7;&#x6C42;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x683C;&#x5F0F;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>{</div><div class="line">    <span class="function">T <span class="title">convert</span><span class="params">(F value)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x63A5;&#x53E3;&#x975E;&#x5E38;&#x6E05;&#x6670;&#xFF0C;&#x5C06; <code>F</code> &#x8F6C;&#x6362;&#x6210; <code>T</code>&#x3002;</p>
<h3 id="6-1-Factory"><a href="#6-1-Factory" class="headerlink" title="6.1 Factory"></a>6.1 Factory</h3><p>&#x6765;&#x770B; <code>Converter.Factory</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>{</div><div class="line">    <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</div><div class="line">        Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Converter&lt;?, String&gt; stringConverter(Type type, Annotation[] annotations, Retrofit retrofit) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<ol>
<li><code>responseBodyConverter</code> &#x7528;&#x4E8E;&#x5C06; HTTP &#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684; response &#x8F6C;&#x6362;&#x6210;&#x6211;&#x4EEC;&#x6307;&#x5B9A;&#x7684;&#x7C7B;&#x578B;&#x3002;</li>
<li><code>requestBodyConverter</code> &#x7528;&#x4E8E;&#x5C06; <code>Body</code>&#x3001;<code>Part</code>&#x3001;<code>PartMap</code> 3&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x53C2;&#x6570;&#x8F6C;&#x6362;&#x6210; HTTP &#x7684;&#x8BF7;&#x6C42;&#x4F53;&#x3002;</li>
<li><code>stringConverter</code> &#x7528;&#x4E8E;&#x5C06; <code>Field</code>&#x3001;<code>FieldMap</code>&#x3001;<code>Header</code>&#x3001;<code>Path</code>&#x3001;<code>Query</code>&#x3001;<code>QueryMap</code> &#x8FD9;&#x51E0;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x53C2;&#x6570;&#x8F6C;&#x6362;&#x6210; <code>String</code>&#x3002;</li>
</ol>
<h3 id="6-2-retrofit-converters"><a href="#6-2-retrofit-converters" class="headerlink" title="6.2 retrofit-converters"></a>6.2 retrofit-converters</h3><p>&#x548C; <code>CallAdapter</code> &#x7C7B;&#x4F3C;&#xFF0C;Retrofit &#x4E5F;&#x63D0;&#x4F9B;&#x4E86;&#x9ED8;&#x8BA4;&#x7684; <code>Converter.Factory</code>&#x2014;&#x2014;<code>BuiltInConverters</code>&#xFF0C;&#x53EA;&#x80FD;&#x5904;&#x7406;&#x57FA;&#x672C;&#x7684; <code>ResponseBody</code>&#x3001;<code>RequestBody</code> &#x548C; <code>String</code> &#x7C7B;&#x578B;&#x3002;</p>
<p>&#x5728; Retrofit &#x63D0;&#x4F9B;&#x7684; <code>retrofit-converters</code> &#x6A21;&#x5757;&#xFF0C;&#x4F9B;&#x6211;&#x4EEC;&#x9009;&#x62E9;&#x7684;&#x6709; <code>Gson</code>&#x3001;<code>Jackson</code>&#x3001;<code>Moshi</code>&#x3001;<code>Protocol Buffers</code>&#x3001;<code>XML</code>&#x3001;<code>Scalar</code> &#x548C; <code>Wire</code>&#xFF0C;&#x6211;&#x4EEC;&#x5E38;&#x7528;&#x7684;&#x6709; <code>GsonConverterFactory</code>&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;<a href="https://github.com/JakeWharton" target="_blank" rel="external">Jake Wharton</a> &#x5728;&#x4ED6;&#x7684;&#x4E00;&#x7BC7;&#x6F14;&#x8BB2; <a href="https://realm.io/news/droidcon-jake-wharton-simple-http-retrofit-2/" target="_blank" rel="external">Simple HTTP with Retrofit 2</a> &#x4E2D;&#x8BF4;&#x9053;</p>
<blockquote>
<p>I want to stress that the order matters. This is the order in which we&#x2019;re going to ask each one whether or not it can handle a type. What I have written above is actually wrong. If we ever specify a proto, it&#x2019;s going to be encoded as JSON, which will try and deserialize the response buddy as JSON. That&#x2019;s obviously not what we want. We will have to flip these because we want to check protocol buffers first, and then JSON through GSON.</p>
</blockquote>
<p>&#x8BF4;&#x7684;&#x5C31;&#x662F; <code>Retrofit.Builder#addConverterFactory</code> &#x7684;&#x987A;&#x5E8F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x5148;&#x6DFB;&#x52A0;&#x7684; <code>Converter.Factory</code> &#x4F1A;&#x5148;&#x7528;&#x6765;&#x89E3;&#x6790;&#xFF0C;&#x800C; Gson &#x975E;&#x5E38;&#x5F3A;&#x5927;&#xFF0C;&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x6DFB;&#x52A0; <code>GsonConverterFactory</code>&#xFF0C;&#x5219;&#x5176;&#x4ED6;&#x60F3;&#x8981;&#x8F6C;&#x6362;&#x7684;&#x7C7B;&#x578B;&#x5982; <code>Protocol Buffers</code> &#x5C31;&#x4E0D;&#x4F1A;&#x6267;&#x884C;&#xFF0C;&#x56E0;&#x6B64;<strong>&#x5EFA;&#x8BAE;&#x5C06; <code>GsonConverterFactory</code> &#x4F5C;&#x4E3A;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x6DFB;&#x52A0;</strong>&#x3002;</p>
<h1 id="7-&#x603B;&#x7ED3;"><a href="#7-&#x603B;&#x7ED3;" class="headerlink" title="7. &#x603B;&#x7ED3;"></a>7. &#x603B;&#x7ED3;</h1><p>Retrofit &#x7684;&#x6E90;&#x7801;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x7684;&#xFF0C;&#x53CD;&#x53CD;&#x590D;&#x590D;&#x770B;&#x4E86;&#x5F88;&#x591A;&#x904D;&#xFF0C;&#x9664;&#x4E86;&#x5176;&#x539F;&#x7406;&#x548C;&#x6D41;&#x7A0B;&#x5916;&#xFF0C;&#x4ECE;&#x4E2D;&#x4E5F;&#x5B66;&#x5230;&#x4E86;&#x4E00;&#x4E9B;&#x6280;&#x5DE7;&#x548C;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x3002;&#x5728;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x540C;&#x65F6;&#x53C8;&#x628A;&#x601D;&#x8DEF;&#x548C;&#x6D41;&#x7A0B;&#x91CD;&#x65B0;&#x7406;&#x4E86;&#x4E00;&#x904D;&#xFF0C;&#x5BF9;&#x81EA;&#x5DF1;&#x5E2E;&#x52A9;&#x8FD8;&#x662F;&#x975E;&#x5E38;&#x5927;&#x7684;&#x3002;&#x5173;&#x4E8E;&#x6E90;&#x7801;&#x6700;&#x5927;&#x7684;&#x611F;&#x53D7;&#x5C31;&#x662F;&#x5404;&#x4E2A;&#x7C7B;&#x4E4B;&#x95F4;&#x4F20;&#x5BF9;&#x8C61;&#x8C03;&#x7528;&#x611F;&#x89C9;&#x975E;&#x5E38;&#x4E71;&#xFF0C;&#x4E5F;&#x589E;&#x52A0;&#x4E86;&#x7406;&#x89E3;&#x7684;&#x96BE;&#x5EA6;&#xFF0C;&#x5982; <code>Retrofit</code> &#x548C; <code>ServiceMethod</code> &#x4E4B;&#x95F4;&#x5C31;&#x4E92;&#x76F8;&#x4F9D;&#x8D56;&#x3002;</p>
<p>&#x672C;&#x6587;&#x662F; <a href="https://github.com/danke77" target="_blank" rel="external">&#x614C;&#x4E0D;&#x8981;&#x614C;</a> &#x539F;&#x521B;&#xFF0C;&#x53D1;&#x8868;&#x4E8E; <a href="https://danke77.github.io/">https://danke77.github.io/</a>&#xFF0C;&#x8BF7;&#x9605;&#x8BFB;&#x539F;&#x6587;&#x652F;&#x6301;&#x539F;&#x521B; <a href="https://danke77.github.io/2016/08/06/retrofit-source-analysis/">https://danke77.github.io/2016/08/06/retrofit-source-analysis/</a>&#xFF0C;&#x7248;&#x6743;&#x5F52;&#x4F5C;&#x8005;&#x6240;&#x6709;&#xFF0C;&#x8F6C;&#x8F7D;&#x8BF7;&#x6CE8;&#x660E;&#x51FA;&#x5904;&#x3002;</p>
<p>&#x5982;&#x679C;&#x89C9;&#x5F97;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x5BF9;&#x60A8;&#x6709;&#x7528;&#xFF0C;&#x8BF7;&#x968F;&#x610F;&#x6253;&#x8D4F;&#x3002;&#x60A8;&#x7684;&#x652F;&#x6301;&#x5C06;&#x9F13;&#x52B1;&#x6211;&#x7EE7;&#x7EED;&#x521B;&#x4F5C;&#xFF01;</p>
<div style="text-align: center"><br><img src="/2016/08/06/retrofit-source-analysis/weixin_pay_qrcode.png"><br></div>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Android/">Android</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Android/">Android</a>, <a href="/tags/Retrofit/">Retrofit</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:danke77.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Android/">Android</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Retrofit/" style="font-size: 10px;">Retrofit</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2016/08/06/retrofit-source-analysis/">Retrofit 源码分析</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 慌不要慌
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
